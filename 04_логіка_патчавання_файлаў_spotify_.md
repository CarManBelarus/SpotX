# Chapter 4: Логіка патчавання файлаў Spotify


Сардэчна запрашаем у чацвёртую главу нашага падручніка па `Патчар SpotX для Spotify`! У папярэдніх раздзелах мы даведаліся пра [Файлы моў](01_файлы_моў_.md), якія дазваляюць SpotX размаўляць з намі на нашай мове, разгледзелі [Галоўны сцэнарый устаноўкі](02_галоўны_сцэнарый_устаноўкі_.md) (`run.ps1`) як цэнтральны дырыжор праекта і зразумелі, як [Апрацоўка параметраў](03_апрацоўка_параметраў_.md) дазваляе нам даваць сцэнарыю канкрэтныя інструкцыі.

Цяпер мы дабраліся да самага сэрца праекта — **Логікі патчавання файлаў Spotify**. Гэта тая частка SpotX, якая робіць усю "магію", непасрэдна змяняючы файлы Spotify, каб выдаліць рэкламу, уключыць функцыі або прымяніць візуальныя змены.

## Што такое Логіка патчавання і навошта яна патрэбна?

Уявіце сабе Spotify як складаны механізм, сабраны з мноства дэталяў (файлаў). Некаторыя з гэтых дэталяў адказваюць за паказ рэкламы, іншыя — за працу пэўных функцый, трэція — за знешні выгляд.

**Логіка патчавання файлаў Spotify** — гэта набор інструментаў і інструкцый, які дазваляе SpotX выступіць у ролі "хірурга" для гэтага механізма. Замест таго, каб перапісваць Spotify цалкам, SpotX акуратна знаходзіць пэўныя "дэталі" ў яго файлах (участкі кода ці дадзеных) і змяняе іх.

**Галоўная задача логікі патчавання** — мадыфікаваць паводзіны Spotify без доступу да зыходнага кода праграмы, дасягаючы такіх мэтаў, як:

*   Выдаленне аўдыё- і візуальнай рэкламы.
*   Уключэнне функцый, якія могуць быць выключаны па змаўчанні.
*   Прымяненне карыстальніцкіх тэм і візуальных паляпшэнняў.
*   Блакіроўка абнаўленняў.

Гэта асноўны механізм, які дазваляе SpotX выконваць сваю абяцаную функцыянальнасць.

## Якія файлы Spotify патчуюцца?

SpotX працуе ў асноўным з двума тыпамі файлаў Spotify:

1.  **`Spotify.exe`**: Гэта асноўны выканальны файл праграмы. У ім SpotX можа мяняць бінарныя дадзеныя (паслядоўнасці байтаў), напрыклад, каб заблакаваць абнаўленні або выдаліць некаторыя ўбудаваныя праверкі.
2.  **`xpui.spa`**: Гэта файл, які насамрэч з'яўляецца ZIP-архівам. Унутры гэтага архіва знаходзіцца большая частка карыстальніцкага інтэрфейсу Spotify, напісаная на вэб-тэхналогіях (JavaScript `.js`, CSS `.css`, HTML `.html`, JSON `.json`). Большасць візуальных змяненняў, выдаленне рэкламных банэраў і наладжванне паводзін інтэрфейсу адбываецца менавіта тут.

Логіка патчавання ўтрымлівае інструкцыі, як менавіта знайсці патрэбныя месцы ў гэтых файлах і як іх змяніць.

## Як SpotX ведае, што і дзе мяняць?

Гэтае пытанне падводзіць нас да "рэцэптурнай кнігі" SpotX — файла `patches.json`. Гэта файл у фармаце JSON (які лёгка чытаецца як чалавекам, так і праграмай), які змяшчае падрабязныя інструкцыі для кожнага патча.

Унутры `patches.json` вы знойдзеце інфармацыю пра тое, да якога файла прымяняць патч, які тэкст або якія байты шукаць (`match`) і на што іх замяніць (`replace`). Ён таксама можа ўтрымліваць інфармацыю пра тое, для якіх версій Spotify прызначаны пэўны патч.

Напрыклад, фрагмент `patches.json` (спрошчана) можа выглядаць так:

```json
{
  "free": {
    "OffadsonFullscreen": {
      "name": "OffadsonFullscreen",
      "version": { "fr": "", "to": "1.2.13" },
      "match": ["adsEnabled:!0"],
      "replace": ["adsEnabled:!1"]
    }
  },
  "others": {
    "ForcedExp": {
       "name": "ForcedExp",
       "version": { "fr": "1.2.14", "to": "" },
       "match": ["enable:[]","disable:[]","custom:[]"],
       "replace": ["enable:%enableTextVariable%","disable:%disableTextVariable%","custom:%customTextVariable%"]
    },
    "binary": {
        "block_update": {
            "name": "block_update",
            "match": ["\u0000h\\x3a\\/\\/update\\.spotify\\.com"],
            "replace": ["\u0000h\\x3a\\/\\/update\\.spotfy\\.com"]
        }
    }
  }
  // ... іншыя патчы ...
}
```

*   `"free"` і `"others"` - катэгорыі патчаў.
*   `"OffadsonFullscreen"`, `"ForcedExp"`, `"binary"` - імёны канкрэтных патчаў.
*   `"version"` - дыяпазон версій Spotify, для якіх прызначаны патч.
*   `"match"` - што шукаць у файле (тэкст або бінарныя дадзеныя).
*   `"replace"` - на што замяніць знойдзены ўчастак.

Галоўны сцэнарый (`run.ps1`) загружае гэты файл `patches.json` і выкарыстоўвае яго дадзеныя, каб выклікаць патрэбныя функцыі патчавання.

## Як працуе логіка патчавання (Спрошчана)?

Калі вы запускаеце SpotX з пэўнымі параметрамі (напрыклад, `-new_theme`, `-podcasts_off`), Галоўны сцэнарый вызначае, якія функцыі вы хочаце ўключыць. Затым ён загружае `patches.json` і пачынае працэс.

Вось спрошчаны погляд на тое, як Галоўны сцэнарый выкарыстоўвае логіку патчавання:

```mermaid
sequenceDiagram
    participant Карыстальнік
    participant run.ps1 як ГалоўныСцэнарый
    participant patches.json як ФайлПатчаў
    participant SpotifyFiles як ФайлыSpotify (.exe, .spa)
    participant PatchingFunctions як ФункцыіПатчавання (Helper, extract, injection)

    Карыстальнік->>ГалоўныСцэнарый: Запуск з параметрамі (напр., -new_theme)
    ГалоўныСцэнарый->>ФайлПатчаў: Загрузіць patches.json
    ФайлПатчаў-->>ГалоўныСцэнарый: Дадзеныя патчаў
    ГалоўныСцэнарый->>PatchingFunctions: Выклікаць функцыі патчавання (extract/injection) з інструкцыямі
    Note over PatchingFunctions,SpotifyFiles: Інструкцыі ўключаюць: файл для змены, які "хелпер" (тып патча) выкарыстоўваць, якія параметры ўлічыць
    PatchingFunctions->>SpotifyFiles: Адкрыць файл Spotify (напр., xpui.spa)
    PatchingFunctions->>PatchingFunctions: Чытаць змесціва файла
    PatchingFunctions->>PatchingFunctions: Выклікаць Helper з дадзенымі з patches.json і параметрамі
    Helper->>Helper: Праверыць параметры (напр., $new_theme)
    Helper->>Helper: Знайсці і замяніць патрэбны тэкст/байты з patches.json
    Helper-->>PatchingFunctions: Вернуць змененае змесціва
    PatchingFunctions->>SpotifyFiles: Запісаць змененае змесціва назад у файл
    SpotifyFiles-->>PatchingFunctions: Файл зменены
    PatchingFunctions-->>ГалоўныСцэнарый: Гатова
    ГалоўныСцэнарый->>Карыстальнік: Паведаміць пра завяршэнне
```

Як бачыце, Галоўны сцэнарый кіруе працэсам, але сама складаная праца па адкрыцці файлаў, пошуку і замене выконваецца спецыялізаванымі **функцыямі патчавання** (`extract`, `injection`, `Helper`).

## Зазірнем у код: Функцыі патчавання

У файле `run.ps1` ёсць некалькі ключавых функцый, якія адказваюць за логіку патчавання.

**1. Функцыя `Helper`:**
Гэтая функцыя дзейнічае як "міні-дырыжор" для асобных катэгорый патчаў. Яна прымае імя патча (`$paramname`, напрыклад, "OffadsonFullscreen" ці "ForcedExp") і атрымлівае адпаведныя дадзеныя з загружанага `$webjson` (змесціва `patches.json`). Унутры `Helper` часта правяраюцца параметры запуску (напрыклад, `$podcast_off`, `$new_theme`), каб вырашыць, якія *канкрэтныя* змены з пакета патчаў прымяніць. Затым яна выконвае аперацыі пошуку і замены ў тэксце файла, які быў ёй перададзены.

Вось спрошчаны прыклад таго, як `Helper` апрацоўвае патч "ForcedExp" і ўлічвае параметр `$new_theme`:

```powershell
function Helper($paramname) {
    # ... іншы код функцыі Helper ...

    switch ( $paramname ) {
        "ForcedExp" {  
            # Патч для прымусовага ўключэння/выключэння эксперыментальных функцый
            
            $Enable = $webjson.others.EnableExp # Дадзеныя для ўключэння функцый
            $Disable = $webjson.others.DisableExp # Дадзеныя для выключэння функцый
            # ... іншыя дадзеныя патча з $webjson ...

            # ... шмат кода для апрацоўкі эксперыментальных функцый ...

            # Калі параметр $new_theme НЕ быў перададзены, ужываем змены для старой тэмы
            if (!($new_theme) -and [version]$offline -le [version]"1.2.13.661") {
                # Выключаем новыя бакавыя панэлі, якія ўключаюцца ў новай тэме
                Move-Json -n 'RightSidebar', 'LeftSidebar' -t $Enable -f $Disable
                # ... іншыя змены для старой тэмы з patches.json ...
            }
            # Калі параметр $new_theme БЫЎ перададзены, магчыма, дадатковыя змены для новай тэмы
            else {
                # ... код для новай тэмы, які ўлічвае іншыя параметры ($rightsidebar_off, $old_lyrics і г.д.) ...
            }

            # Падрыхтоўка тэксту для пошуку і замены на аснове апрацаваных дадзеных
            # (Выкарыстанне $enableNames, $disableNames, $customTextVariable)
            # ... код для фарміравання $replacements ...

            $replacements | foreach {
                $webjson.others.ForcedExp.replace = $webjson.others.ForcedExp.replace.Replace($replacement[0], $replacement[1])
            }

            $name = "patches.json.others." # Частка назвы для лагавання
            $n = "xpui.js" # Імя файла, які патчыцца
            $contents = "ForcedExp" # Указваем, які патч з patches.json выкарыстоўваем
            $json = $webjson.others # Частка $webjson з дадзенымі гэтага патча
        }
        # ... іншыя варыянты switch для іншых патчаў (Binary, OffadsonFullscreen і г.д.) ...
    }

    # Агульная логіка пошуку і замены, якая выкарыстоўвае $json, $contents, $n
    $paramdata # Зменная, якая змяшчае змесціва файла для патчавання, перададзенае ў Helper

    # Ітэрацыя па кожнай пары match/replace для гэтага патча
    $contents | foreach { 
        # Праверка версіі Spotify
        # ... код праверкі версіі ...

        # Калі версія сумяшчальная
        if ($checkVer -or $translate) { # $translate для асобных выпадкаў, як пераклад
            # Пошук і замена ў $paramdata
            if ($paramdata -match $json.$PSItem.match) { 
                $paramdata = $paramdata -replace $json.$PSItem.match, $json.$PSItem.replace 
            }
            else { 
                # Лагіраванне памылкі, калі шаблон не знойдзены
                # ... код лагіравання ...
            }
        }
    }
    return $paramdata # Вяртаем змененае змесціва файла
}
```

Гэты фрагмент паказвае, як функцыя `Helper` атрымлівае дадзеныя з `patches.json` для пэўнага патча ("ForcedExp"), правярае значэнні параметраў (`$new_theme`), каб адаптаваць патч, а затым выкарыстоўвае ўласцівасці `match` і `replace` з `patches.json` для выканання рэальнай замены тэксту ў змесціве файла (`$paramdata`).

**2. Функцыя `extract`:**
Гэтая функцыя адказвае за адкрыццё файлаў Spotify (альбо ўнутры `xpui.spa`, альбо `Spotify.exe`), перадачу іх змесціва ў функцыю `Helper` для апрацоўкі і захаванне змен назад у файл. Яна прымае параметры, якія паказваюць, які файл трэба апрацаваць (`-name`), дзе ён знаходзіцца (`-method`, напрыклад, 'zip' для `xpui.spa`), які "хелпер" (`-helper`) выкарыстоўваць і ці трэба дадаць дадатковы кантэнт (`-add`).

Вось як Галоўны сцэнарый выклікае `extract` для патча xpui.js, які залежыць ад параметраў (праз `Helper 'VariousofXpui-js'`) і патча exe-файла (`Helper 'Binary'`):

```powershell
# Мадыфікацыя файлаў у архіве xpui.spa
if ($test_spa) {
    # ... код падрыхтоўкі файлаў у архіве, уключаючы, магчыма, аднаўленне з бэкапу ...

    # Выклік extract для апрацоўкі xpui.js з рознымі патчамі праз Helper 'VariousofXpui-js'
    # Уся логіка ўліку параметраў ($podcasts_off, $adsections_off, $canvashome_off, $premium, $cache_limit і г.д.)
    # адбываецца ўнутры Helper 'VariousofXpui-js', які працуе з дадзенымі з patches.json.VariousJs
    extract -counts 'one' -method 'zip' -name 'xpui.js' -helper 'VariousofXpui-js'
    
    # ... выклікі extract/injection для іншых файлаў у xpui.spa (css, html, іншыя js) ...
}

# Патчаванне асноўнага выканальнага файла Spotify.exe
# Функцыя Helper 'Binary' улічвае параметры $not_block_update і $premium
extract -counts 'exe' -helper 'Binary'

# ... код для іншых налад ...
```

У гэтым прыкладзе Галоўны сцэнарый проста выклікае `extract`, перадаючы яму імя файла, метад (zip або exe) і імя "хелпера". Уся складаная логіка вырашэння, якія *канкрэтна* змены ўнесці ў файл на аснове параметраў, змешчана ўнутры функцыі `Helper`.

**3. Функцыя `injection`:**
Гэтая функцыя выкарыстоўваецца для дадання цалкам новых файлаў (звычайна `.js` або `.css` хелпераў, якія SpotX спампоўвае з інтэрнэту) у архіў `xpui.spa` і іх падключэння да `index.html`, каб Spotify іх загрузіў і выканаў. Гэта альтэрнатыўны метад патчавання, калі прасцей дадаць новы код, чым мадыфікаваць існуючы.

Вось як SpotX можа ўставіць `sectionBlock.js` для блакіроўкі секцый на галоўнай старонцы (залежыць ад параметраў `$podcast_off` або `$adsections_off`):

```powershell
# Hiding Ad-like sections or turn off podcasts from the homepage
if ($podcast_off -or $adsections_off) { # Праверка параметраў

    # Спампоўваем змесціва файла-хелпера з інтэрнэту
    $section = Get -Url (Get-Link -e "/js-helper/sectionBlock.js")
    
    if ($section -ne $null) {
        # Выклікаем injection для дадання файла ў xpui.spa
        injection -p $xpui_spa_patch -f "spotx-helper" -n "sectionBlock.js" -c $section -i "sectionBlock.js"
    }
    else {
        # Калі спампаваць не ўдалося, адключаем функцыю
        $podcast_off, $adsections_off = $false
    }
}
```

Тут функцыя `injection` прымае шлях да архіва `xpui.spa` (`-p`), тэчку ўнутры архіва, куды трэба змясціць файл (`-f`), імя файла (`-n`), яго змесціва (`-c`) і паказвае, які файл падключыць у `index.html` (`-i`).

## Высновы

Логіка патчавання файлаў Spotify — гэта складаны, але вельмі дасціпны механізм, які дазваляе `Патчар SpotX для Spotify` мадыфікаваць праграму Spotify без доступу да яе зыходнага кода. Выкарыстоўваючы дадзеныя з файла `patches.json` як "рэцэпты" і функцыі патчавання (`extract`, `injection`, `Helper`) як "інструменты", SpotX знаходзіць і змяняе пэўныя ўчасткі ў файлах `Spotify.exe` і `xpui.spa`. Параметры запуску, якія мы вывучалі ў папярэдняй главе, наўпрост уплываюць на гэтую логіку, вызначаючы, якія менавіта змены будуць прыменены праз функцыю `Helper`.

Разуменне логікі патчавання дапамагае ўбачыць, як SpotX насамрэч працуе на нізкім узроўні і як вашыя выбары (праз параметры) уплываюць на канчатковы вынік.

У наступнай главе мы разгледзім [Сцэнарый выдалення](05_сцэнарый_выдалення_.md) і даведаемся, як SpotX дапамагае вярнуць Spotify да зыходнага стану.

[Глава 5: Сцэнарый выдалення](05_сцэнарый_выдалення_.md)

---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)